#!/usr/bin/env python3
"""
ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æ–™ç†ç¨®é¡ã‚¿ã‚°ã‚’è‡ªå‹•ä»˜ä¸ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ä½¿ç”¨æ–¹æ³•:
    python scripts/categorize_food_types.py
    python scripts/categorize_food_types.py --dry-run  # å¤‰æ›´ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿
"""

import json
import re
from pathlib import Path
from typing import List, Dict, Set
import argparse


# æ–™ç†ç¨®é¡ã®ã‚·ã‚°ãƒãƒãƒ£å®šç¾©ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â†’ ã‚¿ã‚°ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
FOOD_TYPE_SIGNATURES = {
    "éººé¡": {
        "keywords": [
            "éºº",  # è¿½åŠ : ã€Œéººã€ã‚’å«ã‚€å…¨ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            "ãƒ©ãƒ¼ãƒ¡ãƒ³",
            "ã‚‰ãƒ¼ã‚ã‚“",
            "æ‹‰éºº",
            "ã†ã©ã‚“",
            "é¥‚é£©",
            "ãã°",
            "è•éº¦",
            "ãƒ‘ã‚¹ã‚¿",
            "ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£",
            "ã‚¹ãƒ‘ã‚²ãƒ†ã‚£",
            "ãƒšãƒ³ãƒ",
            "ãƒ•ã‚§ãƒƒãƒˆãƒãƒ¼ãƒ",
            "ã‚¿ãƒªã‚ªãƒªãƒ¼ãƒ‹",
            "ãƒªãƒ³ã‚°ã‚¤ãƒ",
            "ãƒŒãƒ¼ãƒ‰ãƒ«",
            "ãƒ•ã‚©ãƒ¼",
            "ç±³ç²‰éºº",
        ],
        "exclude_keywords": ["ãƒŒãƒ¼ãƒ‰ãƒ«ã‚¹ãƒ¼ãƒ—"],  # é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    },
    "ã”é£¯ã‚‚ã®": {
        "keywords": [
            "ãƒ©ã‚¤ã‚¹",
            "ã”é£¯",
            "å¾¡é£¯",
            "ç™½é£¯",
            "ç™½ã”é£¯",
            "ã‚«ãƒ¬ãƒ¼",
            "ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹",
            "ãƒ”ãƒ©ãƒ•",
            "ãƒªã‚¾ãƒƒãƒˆ",
            "ãƒ‰ãƒªã‚¢",
            "ãƒãƒ£ãƒ¼ãƒãƒ³",
            "ç‚’é£¯",
            "ç„¼ãé£¯",
            "ä¸¼",
            "ã©ã‚“ã¶ã‚Š",
            "ãŠã«ãã‚Š",
            "ãŠã‚€ã™ã³",
            "é›‘ç‚Š",
            "ãƒªã‚¾ãƒƒãƒˆ",
        ],
        "exclude_keywords": ["ãƒ©ã‚¤ã‚¹ã‚³ãƒ­ãƒƒã‚±", "ãƒ©ã‚¤ã‚¹ãƒšãƒ¼ãƒ‘ãƒ¼"],
    },
    "ãƒ‘ãƒ³": {
        "keywords": [
            "ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ",
            "ã‚µãƒ³ãƒ‰",
            "ãƒãƒ¼ã‚¬ãƒ¼",
            "ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼",
            "ãƒ›ãƒƒãƒˆãƒ‰ãƒƒã‚°",
            "ãƒ›ãƒƒãƒˆãƒ‰ãƒƒã‚¯",
            "ãƒ‘ãƒ³",
            "ãƒãƒ³ã‚º",
            "ãƒ–ãƒ¬ãƒƒãƒ‰",
            "ãƒ™ãƒ¼ã‚°ãƒ«",
            "ãƒãƒ•ã‚£ãƒ³",
            "ãƒˆãƒ¼ã‚¹ãƒˆ",
            "ã‚¯ãƒ­ãƒ¯ãƒƒã‚µãƒ³",
            "ãƒ‡ãƒ‹ãƒƒã‚·ãƒ¥",
        ],
        "exclude_keywords": ["ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­", "ãƒ‘ãƒ³ãƒŠã‚³ãƒƒã‚¿", "ãƒ‘ãƒ³ãƒ—ã‚­ãƒ³", "ãƒ‘ãƒ³ãƒ€", "ã‚¢ã‚¯ã‚¢ãƒ‘ãƒ³ãƒŠ"],
    },
    "è‚‰æ–™ç†": {
        "keywords": [
            "ã‚¹ãƒ†ãƒ¼ã‚­",
            "ç‰›è‚‰",
            "ãƒ“ãƒ¼ãƒ•",
            "ãƒãƒ¼ã‚¯",
            "è±šè‚‰",
            "ãƒãƒ¼ã‚¯ã‚«ãƒ„",
            "ã¨ã‚“ã‹ã¤",
            "ãƒã‚­ãƒ³",
            "é¶è‚‰",
            "ãƒã‚­ãƒ³ãƒ¬ãƒƒã‚°",
            "ãƒ­ãƒ¼ã‚¹ãƒˆãƒã‚­ãƒ³",
            "ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸",
            "ã‚¦ã‚¤ãƒ³ãƒŠãƒ¼",
            "ãƒãƒ ",
            "ç”Ÿãƒãƒ ",
            "ãƒ™ãƒ¼ã‚³ãƒ³",
            "ã‚¿ãƒ¼ã‚­ãƒ¼",
            "ä¸ƒé¢é³¥",
            "ãƒ©ãƒ ",
            "ç¾Šè‚‰",
            "ãƒŸãƒ¼ãƒˆãƒœãƒ¼ãƒ«",
            "ãƒãƒ³ãƒãƒ¼ã‚°",
        ],
        "exclude_keywords": ["ãƒãƒ ã‚¹ã‚¿ãƒ¼"],
    },
    "é­šä»‹æ–™ç†": {
        "keywords": [
            "ã‚·ãƒ¼ãƒ•ãƒ¼ãƒ‰",
            "é­šä»‹",
            "ã‚µãƒ¼ãƒ¢ãƒ³",
            "é®­",
            "ã‚µã‚±",
            "ã‚¨ãƒ“",
            "æµ·è€",
            "ã‚·ãƒ¥ãƒªãƒ³ãƒ—",
            "ãƒ—ãƒ©ã‚¦ãƒ³",
            "é­š",
            "ãƒ•ã‚£ãƒƒã‚·ãƒ¥",
            "ç™½èº«é­š",
            "ãƒ›ã‚¿ãƒ†",
            "å¸†ç«‹",
            "ã‚¤ã‚«",
            "çƒè³Š",
            "ã‚¤ã‚«å¢¨",
            "ã‚¿ã‚³",
            "è›¸",
            "ã‚ªã‚¯ãƒˆãƒ‘ã‚¹",
            "ãƒ„ãƒŠ",
            "ã¾ãã‚",
            "ãƒã‚°ãƒ­",
            "ã‚«ã‚­",
            "ç‰¡è £",
            "ã‚ªã‚¤ã‚¹ã‚¿ãƒ¼",
            "èŸ¹",
            "ã‚«ãƒ‹",
            "ã‚¯ãƒ©ãƒ–",
            "ã‚¢ã‚µãƒª",
            "ãƒ ãƒ¼ãƒ«è²",
        ],
        "exclude_keywords": [],
    },
    "ãƒ”ã‚¶": {
        "keywords": [
            "ãƒ”ã‚¶",
            "ãƒ”ãƒƒãƒ„ã‚¡",
            "ãƒ”ãƒƒãƒ„ã‚¢",
        ],
        "exclude_keywords": [],
    },
    "ã‚¹ãƒ¼ãƒ—": {
        "keywords": [
            "ã‚¹ãƒ¼ãƒ—",
            "ãƒŒãƒ¼ãƒ‰ãƒ«ã‚¹ãƒ¼ãƒ—",
            "ã‚·ãƒãƒ¥ãƒ¼",
            "ãƒã‚¿ãƒ¼ã‚¸ãƒ¥",
            "ãƒãƒ£ã‚¦ãƒ€ãƒ¼",
            "ã‚¯ãƒ©ãƒ ãƒãƒ£ã‚¦ãƒ€ãƒ¼",
            "ã‚³ãƒ³ã‚½ãƒ¡",
            "ãƒ–ã‚¤ãƒ¨ãƒ³",
        ],
        "exclude_keywords": [],
    },
    "ã‚µãƒ©ãƒ€": {
        "keywords": [
            "ã‚µãƒ©ãƒ€",
        ],
        "exclude_keywords": [],
    },
    "æšã’ç‰©": {
        "keywords": [
            "ãƒ•ãƒ©ã‚¤",
            "ãƒ•ãƒ©ã‚¤ãƒ‰ãƒãƒ†ãƒˆ",
            "ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³",
            "å¤©ã·ã‚‰",
            "å¤©éº©ç¾…",
            "ã¦ã‚“ã·ã‚‰",
            "å”æšã’",
            "ã‹ã‚‰æšã’",
            "ã‹ã‚‰ã‚ã’",
            "ã‚«ãƒ„",
            "ã¨ã‚“ã‹ã¤",
            "ãƒãƒ¼ã‚¯ã‚«ãƒ„",
            "ãƒã‚­ãƒ³ã‚«ãƒ„",
            "ã‚³ãƒ­ãƒƒã‚±",
            "ãƒ•ãƒªãƒƒã‚¿ãƒ¼",
            "ãƒ•ãƒªãƒƒãƒˆ",
        ],
        "exclude_keywords": ["ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³"],
    },
    "ç‚¹å¿ƒ": {
        "keywords": [
            "é¤ƒå­",
            "ã‚®ãƒ§ã‚¦ã‚¶",
            "ãã‚‡ã†ã–",
            "ç„¼å£²",
            "ã‚·ãƒ¥ã‚¦ãƒã‚¤",
            "ã—ã‚…ã†ã¾ã„",
            "æ˜¥å·»ã",
            "æ˜¥å·»",
            "ã¯ã‚‹ã¾ã",
            "è‚‰ã¾ã‚“",
            "ã‚ã‚“ã¾ã‚“",
            "è‚‰é¥…é ­",
            "å°ç± åŒ…",
            "ã‚·ãƒ§ã‚¦ãƒ­ãƒ³ãƒã‚¦",
            "ç‚¹å¿ƒ",
            "é£²èŒ¶",
        ],
        "exclude_keywords": [],
    },
    "ãƒ‡ã‚¶ãƒ¼ãƒˆ": {
        "keywords": [
            "ã‚±ãƒ¼ã‚­",
            "ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­",
            "ãƒãƒ¼ã‚ºã‚±ãƒ¼ã‚­",
            "ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã‚±ãƒ¼ã‚­",
            "ã‚¿ãƒ«ãƒˆ",
            "ãƒ‘ã‚¤",
            "ãƒ—ãƒªãƒ³",
            "ã‚«ã‚¹ã‚¿ãƒ¼ãƒ‰ãƒ—ãƒªãƒ³",
            "ã‚¼ãƒªãƒ¼",
            "ã‚¸ãƒ¥ãƒ¬",
            "ãƒ ãƒ¼ã‚¹",
            "ãƒãƒãƒ­ã‚¢",
            "ãƒ‘ãƒ³ãƒŠã‚³ãƒƒã‚¿",
            "ãƒ†ã‚£ãƒ©ãƒŸã‚¹",
            "ãƒ‘ãƒ•ã‚§",
            "ã‚µãƒ³ãƒ‡ãƒ¼",
            "ã‚¯ãƒ¬ãƒ¼ãƒ—",
            "ãƒ¯ãƒƒãƒ•ãƒ«",
            "ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­",
            "ãƒ›ãƒƒãƒˆã‚±ãƒ¼ã‚­",
            "ã‚·ãƒ¥ãƒ¼ã‚¯ãƒªãƒ¼ãƒ ",
            "ã‚¨ã‚¯ãƒ¬ã‚¢",
            "ãƒã‚«ãƒ­ãƒ³",
            "ã‚¯ãƒƒã‚­ãƒ¼",
            "ãƒ“ã‚¹ã‚±ãƒƒãƒˆ",
            "ãƒ–ãƒ©ã‚¦ãƒ‹ãƒ¼",
            "ãƒãƒ•ã‚£ãƒ³",
        ],
        "exclude_keywords": [
            "ã‚¢ã‚¤ã‚¹",
            "ãƒ“ãƒ¼ãƒ•ãƒ‘ã‚¤",
            "ãƒŸãƒ¼ãƒˆãƒ‘ã‚¤",
            "ãƒã‚­ãƒ³ãƒ‘ã‚¤",
            "ãƒãƒ¼ã‚¯ãƒ‘ã‚¤",
        ],  # ã‚¢ã‚¤ã‚¹ã¯åˆ¥ã‚«ãƒ†ã‚´ãƒªã€è‚‰ãƒ‘ã‚¤ã¯ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒƒã‚·ãƒ¥
    },
    "ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ": {
        "keywords": [
            "ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ",
            "ã‚¢ã‚¤ã‚¹",
            "ã‚¸ã‚§ãƒ©ãƒ¼ãƒˆ",
            "ã‚½ãƒ•ãƒˆã‚¯ãƒªãƒ¼ãƒ ",
            "ã‚½ãƒ•ãƒˆ",
            "ã‚·ãƒ£ãƒ¼ãƒ™ãƒƒãƒˆ",
            "ã‚½ãƒ«ãƒ™",
            "ãƒ•ãƒ­ãƒ¼ã‚ºãƒ³ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ",
        ],
        "exclude_keywords": ["ã‚¢ã‚¤ã‚¹ã‚³ãƒ¼ãƒ’ãƒ¼", "ã‚¢ã‚¤ã‚¹ãƒ†ã‚£ãƒ¼", "ã‚¢ã‚¤ã‚¹ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶", "ã‚¢ã‚¤ã‚¹ãƒŸãƒ«ã‚¯"],
    },
}


def load_menus(file_path: str) -> List[Dict]:
    """ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€"""
    with open(file_path, "r", encoding="utf-8") as f:
        return json.load(f)


def save_menus(file_path: str, menus: List[Dict]):
    """ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹"""
    with open(file_path, "w", encoding="utf-8") as f:
        json.dump(menus, f, ensure_ascii=False, indent=2)


def detect_food_types(menu: Dict, signatures: Dict) -> Set[str]:
    """ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ–™ç†ç¨®é¡ã‚’æ¤œå‡ºã™ã‚‹"""
    name = menu.get("name", "")
    description = menu.get("description", "")
    combined_text = f"{name} {description}"

    detected_types = set()

    for food_type, rules in signatures.items():
        keywords = rules["keywords"]
        exclude_keywords = rules.get("exclude_keywords", [])

        # é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
        if any(exclude in combined_text for exclude in exclude_keywords):
            continue

        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ
        if any(keyword in combined_text for keyword in keywords):
            detected_types.add(food_type)

    return detected_types


def categorize_menus(menus: List[Dict], signatures: Dict, dry_run: bool = False) -> Dict:
    """å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æ–™ç†ç¨®é¡ã‚¿ã‚°ã‚’ä»˜ä¸"""
    stats = {
        "total": len(menus),
        "updated": 0,
        "added_tags": 0,
        "by_type": {},
    }

    for menu in menus:
        detected_types = detect_food_types(menu, signatures)

        if not detected_types:
            continue

        # æ—¢å­˜ã®ã‚¿ã‚°ã‚’å–å¾—
        existing_tags = set(menu.get("tags", []))

        # æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ 
        new_tags = detected_types - existing_tags

        if new_tags:
            if not dry_run:
                menu["tags"] = sorted(existing_tags | detected_types)

            stats["updated"] += 1
            stats["added_tags"] += len(new_tags)

            for tag in new_tags:
                stats["by_type"][tag] = stats["by_type"].get(tag, 0) + 1

    return stats


def main():
    parser = argparse.ArgumentParser(description="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æ–™ç†ç¨®é¡ã‚¿ã‚°ã‚’è‡ªå‹•ä»˜ä¸")
    parser.add_argument("--dry-run", action="store_true", help="å¤‰æ›´ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼ˆå®Ÿéš›ã«ã¯ä¿å­˜ã—ãªã„ï¼‰")
    parser.add_argument("--input", default="data/menus.json", help="å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹")
    parser.add_argument("--output", default=None, help="å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆæŒ‡å®šã—ãªã„å ´åˆã¯å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãï¼‰")
    args = parser.parse_args()

    input_path = args.input
    output_path = args.output or input_path

    print(f"ğŸ“‚ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­: {input_path}")
    menus = load_menus(input_path)

    print(f"ğŸ” æ–™ç†ç¨®é¡ã‚’æ¤œå‡ºä¸­...")
    print(f"   å¯¾è±¡ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°: {len(menus)}")
    print(f"   æ–™ç†ç¨®é¡ã‚«ãƒ†ã‚´ãƒªæ•°: {len(FOOD_TYPE_SIGNATURES)}")

    stats = categorize_menus(menus, FOOD_TYPE_SIGNATURES, dry_run=args.dry_run)

    print("\n" + "=" * 60)
    print("ğŸ“Š å‡¦ç†çµæœ")
    print("=" * 60)
    print(f"ç·ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°: {stats['total']}")
    print(f"ã‚¿ã‚°è¿½åŠ ã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°: {stats['updated']}")
    print(f"è¿½åŠ ã•ã‚ŒãŸã‚¿ã‚°ç·æ•°: {stats['added_tags']}")

    if stats["by_type"]:
        print("\nã€æ–™ç†ç¨®é¡åˆ¥ã®è¿½åŠ æ•°ã€‘")
        for food_type, count in sorted(stats["by_type"].items(), key=lambda x: x[1], reverse=True):
            print(f"  {food_type}: {count}ä»¶")

    if not args.dry_run:
        print(f"\nğŸ’¾ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­: {output_path}")
        save_menus(output_path, menus)
        print("âœ… å®Œäº†ï¼")
    else:
        print("\nâš ï¸  ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        print("   å®Ÿéš›ã«ä¿å­˜ã™ã‚‹ã«ã¯ --dry-run ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å¤–ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„")


if __name__ == "__main__":
    main()
