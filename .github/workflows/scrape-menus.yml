name: Weekly Menu Scraping

on:
  # æ¯é€±æ—¥æ›œæ—¥ã®åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 18 * * 0'  # UTC 18:00 = JST 3:00

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      start_id:
        description: 'é–‹å§‹IDï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ï¼‰'
        required: false
        default: '0'
      end_id:
        description: 'çµ‚äº†IDï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 9999ï¼‰'
        required: false
        default: '9999'

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run scraping script
        env:
          START_ID: ${{ github.event.inputs.start_id || '0' }}
          END_ID: ${{ github.event.inputs.end_id || '9999' }}
        run: |
          python scripts/scrape_menus_simple.py \
            --start ${START_ID} \
            --end ${END_ID} \
            --output data/menus.json \
            --rate-limit 1.0

      - name: Apply category assignments
        run: |
          echo "ğŸ“ ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•å‰²ã‚Šå½“ã¦ä¸­..."
          python scripts/assign_categories.py data/menus.json

      - name: Clean and normalize tags
        run: |
          echo "ğŸ·ï¸  ã‚¿ã‚°ã‚’æ­£è¦åŒ–ä¸­..."
          python scripts/clean_tags.py data/menus.json

      - name: Categorize food types
        run: |
          echo "ğŸ½ï¸  æ–™ç†ç¨®é¡ã‚¿ã‚°ã‚’ä»˜ä¸ä¸­..."
          python scripts/categorize_food_types.py --input data/menus.json

      - name: Validate processed data
        run: |
          echo "âœ“ ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ä¸­..."
          python scripts/validate_menus.py data/menus.json

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code data/menus.json || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
          MENU_COUNT=$(python scripts/generate_commit_stats.py data/menus.json | grep MENU_COUNT | cut -d= -f2)
          FOOD_TAG_STATS=$(python scripts/generate_commit_stats.py data/menus.json | grep FOOD_TAG_STATS | cut -d= -f2)

          git add data/menus.json

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½¿ç”¨ï¼‰
          git commit -F - <<EOF
          chore: é€±æ¬¡ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°

          - ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œæ—¥æ™‚: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - ç·ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°: ${MENU_COUNT}ä»¶
          - æ–™ç†ç¨®é¡ã‚¿ã‚°: ${FOOD_TAG_STATS}
          - å‡¦ç†: ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° â†’ ã‚«ãƒ†ã‚´ãƒªå‰²å½“ â†’ ã‚¿ã‚°æ­£è¦åŒ– â†’ æ–™ç†ç¨®é¡ã‚¿ã‚°ä»˜ä¸
          - è‡ªå‹•å®Ÿè¡Œ: GitHub Actions
          EOF

          git push

      - name: Deploy to Vercel
        if: steps.git-check.outputs.changed == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # Vercel CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g vercel

          # æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
          echo "ğŸš€ Vercelã¸ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
          vercel --prod --yes \
            --token ${VERCEL_TOKEN} \
            || echo "âš ï¸  Vercelãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆSecretsãŒæœªè¨­å®šã®å¯èƒ½æ€§ï¼‰"

      - name: Create summary
        if: always()
        run: |
          if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
            python scripts/generate_summary.py data/menus.json changed >> $GITHUB_STEP_SUMMARY
          else
            python scripts/generate_summary.py data/menus.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload artifact on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scraping-logs
          path: |
            data/menus.json
            *.log
          retention-days: 7
